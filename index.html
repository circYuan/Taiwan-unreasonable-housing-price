<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台灣行政區房價（季度/指標切換）</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    html, body { height: 100%; margin: 0; background: #fff; }
    #map { height: 100%; background: #fff; }

    .panel {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      background: rgba(255,255,255,0.95);
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      font-size: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.10);
      min-width: 360px;
    }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .title { font-weight: 700; }
    .muted { color: #555; font-size: 12px; }
    select { padding: 4px 6px; }

    .legend {
      position: absolute;
      right: 16px;
      bottom: 16px;
      z-index: 999;
      background: rgba(255,255,255,0.95);
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      font-size: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.10);
      min-width: 220px;
    }
    .legend-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .swatch { width: 14px; height: 14px; border: 1px solid #999; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel" id="panel">
    <div class="row">
      <div class="title">行政區：<span id="name">（滑鼠移上去）</span></div>
      <div class="muted">樣本數：<span id="count">—</span></div>
    </div>
    <div class="row" style="margin-top:6px;">
      <div id="value">—</div>
      <div class="muted" id="unit"> </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="muted">季度：</div>
      <select id="quarter"></select>

      <div class="muted">指標：</div>
      <select id="metric">
        <option value="median_total_price">總價中位數</option>
        <option value="median_unit_price_ping">單價中位數（元/坪）</option>
      </select>

      <div class="muted">（樣本 < 10 會淡化）</div>
    </div>
  </div>

  <div class="legend" id="legend"></div>

  <script>
    const map = L.map("map", { attributionControl: false, zoomControl: true });

    const elName = document.getElementById("name");
    const elCount = document.getElementById("count");
    const elValue = document.getElementById("value");
    const elUnit = document.getElementById("unit");
    const quarterSel = document.getElementById("quarter");
    const metricSel = document.getElementById("metric");
    const legendEl = document.getElementById("legend");

    let geoData = null;
    let statsAll = null;   // {quarters:[], data:{q:{admin_key:{...}}}}
    let geoLayer = null;
    let selectedLayer = null;

    const colors = ["#f7fbff", "#deebf7", "#c6dbef", "#9ecae1", "#6baed6", "#3182bd", "#08519c"];

    function townKey(props) {
      return ((props.COUNTYNAME ?? "") + (props.TOWNNAME ?? "")).trim();
    }

    function label(props) {
      return ((props.COUNTYNAME ?? "") + " " + (props.TOWNNAME ?? "")).trim() || "（未知）";
    }

    function fmtWan(td) {
      if (td == null) return "—";
      return Math.round(td / 10000).toLocaleString("zh-Hant-TW") + " 萬";
    }

    function fmtPing(tdPerPing) {
      if (tdPerPing == null) return "—";
      return Math.round(tdPerPing).toLocaleString("zh-Hant-TW") + " 元/坪";
    }

    function getCurrentQuarter() {
      return quarterSel.value;
    }

    function getCurrentMetric() {
      return metricSel.value;
    }

    // 取得目前選擇季度的 stats map： { admin_key: {count, median_total_price, median_unit_price_ping} }
    function getStatsForQuarter(q) {
      return statsAll?.data?.[q] || {};
    }

    // 分位數門檻（6 thresholds -> 7 colors）
    function computeQuantileThresholds(values) {
      // values: sorted ascending
      const qs = [1/7, 2/7, 3/7, 4/7, 5/7, 6/7];
      const th = qs.map(p => {
        const idx = Math.floor(p * (values.length - 1));
        return values[idx];
      });
      return th;
    }

    function colorFor(v, thresholds) {
      if (v == null) return "#eee";
      // 7 colors, 6 thresholds
      if (v < thresholds[0]) return colors[0];
      if (v < thresholds[1]) return colors[1];
      if (v < thresholds[2]) return colors[2];
      if (v < thresholds[3]) return colors[3];
      if (v < thresholds[4]) return colors[4];
      if (v < thresholds[5]) return colors[5];
      return colors[6];
    }

    function buildLegend(thresholds, metric) {
      const labels = [];
      if (!thresholds || thresholds.length !== 6) {
        legendEl.innerHTML = `<div style="font-weight:700;">沒有足夠資料產生圖例</div>`;
        return;
      }

      const fmt = (x) => {
        if (metric === "median_total_price") return Math.round(x/10000).toLocaleString("zh-Hant-TW") + "萬";
        return Math.round(x).toLocaleString("zh-Hant-TW");
      };

      labels.push(`< ${fmt(thresholds[0])}`);
      for (let i = 0; i < 5; i++) labels.push(`${fmt(thresholds[i])}–${fmt(thresholds[i+1])}`);
      labels.push(`≥ ${fmt(thresholds[5])}`);

      const title = metric === "median_total_price" ? "總價中位數（分位數分級）" : "單價中位數（元/坪，分位數分級）";
      legendEl.innerHTML = `
        <div style="font-weight:700; margin-bottom:6px;">${title}</div>
        ${labels.map((lab, i) => `
          <div class="legend-item">
            <span class="swatch" style="background:${colors[i]}"></span>
            <span>${lab}</span>
          </div>
        `).join("")}
        <div class="muted" style="margin-top:8px;">樣本數 < 10：淡灰顯示</div>
      `;
    }

    function setPanel(featureOrNull) {
      if (!featureOrNull) {
        elName.textContent = "（滑鼠移上去）";
        elCount.textContent = "—";
        elValue.textContent = "—";
        elUnit.textContent = "";
        return;
      }
      const props = featureOrNull.properties || {};
      const key = townKey(props);

      const q = getCurrentQuarter();
      const metric = getCurrentMetric();
      const rec = getStatsForQuarter(q)[key];

      elName.textContent = label(props);
      elCount.textContent = rec?.count ?? "—";

      if (!rec) {
        elValue.textContent = "—";
        elUnit.textContent = "";
        return;
      }

      if (metric === "median_total_price") {
        elValue.textContent = `總價中位數：${fmtWan(rec.median_total_price)}`;
        elUnit.textContent = "（單位：萬元）";
      } else {
        elValue.textContent = `單價中位數：${fmtPing(rec.median_unit_price_ping)}`;
        elUnit.textContent = "（單位：元/坪）";
      }
    }

    function render() {
      if (!geoData || !statsAll) return;

      const q = getCurrentQuarter();
      const metric = getCurrentMetric();
      const statsQ = getStatsForQuarter(q);

      // 收集用來做分位數的值（只取樣本 >=10 的行政區）
      const values = Object.values(statsQ)
        .filter(r => (r.count ?? 0) >= 10 && r[metric] != null)
        .map(r => r[metric])
        .sort((a,b) => a-b);

      const thresholds = values.length >= 7 ? computeQuantileThresholds(values) : null;
      buildLegend(thresholds, metric);

      if (geoLayer) geoLayer.remove();
      selectedLayer = null;
      setPanel(null);

      geoLayer = L.geoJSON(geoData, {
        style: (feature) => {
          const key = townKey(feature.properties || {});
          const rec = statsQ[key];
          const ok = rec && (rec.count ?? 0) >= 10;
          const v = rec ? rec[metric] : null;

          return {
            color: "#000",
            weight: 1,
            fillColor: ok && thresholds ? colorFor(v, thresholds) : "#eee",
            fillOpacity: ok && thresholds ? 0.78 : 0.25
          };
        },
        onEachFeature: (feature, layer) => {
          layer.on("mouseover", () => {
            if (selectedLayer && selectedLayer === layer) return;
            layer.setStyle({ weight: 2 });
            layer.bringToFront();
            setPanel(feature);
          });
          layer.on("mouseout", () => {
            if (selectedLayer && selectedLayer === layer) return;
            geoLayer.resetStyle(layer);
            setPanel(null);
          });
          layer.on("click", () => {
            if (selectedLayer && selectedLayer !== layer) {
              geoLayer.resetStyle(selectedLayer);
            }
            selectedLayer = layer;
            layer.setStyle({ weight: 3 });
            layer.bringToFront();
            setPanel(feature);
          });
        }
      }).addTo(map);

      map.fitBounds(geoLayer.getBounds(), { padding: [10, 10] });
    }

    function initQuarterSelector() {
      quarterSel.innerHTML = "";
      const qs = statsAll.quarters || [];
      qs.forEach(q => {
        const opt = document.createElement("option");
        opt.value = q;
        opt.textContent = q;
        quarterSel.appendChild(opt);
      });
      // 預設選最新一季
      if (qs.length) quarterSel.value = qs[qs.length - 1];
    }

    Promise.all([
      fetch("./taiwan_town_simplified.geojson").then(r => r.json()),
      fetch("./stats_by_town_quarter.json").then(r => r.json()),
    ]).then(([g, s]) => {
      geoData = g;
      statsAll = s;
      initQuarterSelector();
      render();
    }).catch(err => {
      console.error(err);
      alert("載入資料失敗：\n" + err.message);
    });

    quarterSel.addEventListener("change", render);
    metricSel.addEventListener("change", render);
  </script>
</body>
</html>

